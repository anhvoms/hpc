{
   "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "adminUserName":{
         "type":"string",
         "defaultValue":"azureuser",
         "metadata":{
            "description":"User name for the Virtual Machine. Pick a valid username otherwise there will be a BadRequest error."
         }
      },
      "adminPassword":{
         "type":"securestring",
         "metadata":{
            "description":"Admin password. Pick a complex password with uppercase letters, lowercase letters, digits, and symbols. The password should not be longer than 16. Otherwise you'll get a BadRequest error."
         }
      },
      "hpcUserName":{
         "type":"string",
         "defaultValue":"hpc",
         "metadata":{
            "description":"User for running HPC applications with shared home directory and SSH public key authentication setup.  This user cannot login from outside the cluster. Pick a valid username otherwise there will be a BadRequest error."
         }
      },
      "imageOffer":{
         "type":"string",
         "defaultValue":"CentOS-HPC",
         "allowedValues":[
            "CentOS",
            "CentOS-HPC"
         ],
         "metadata":{
            "description":"The OS image offer to use, eithe HPC with Intel MPI or the vanilla CentOS version."
         }
      },
      "nodeSize":{
         "type":"string",
         "defaultValue":"Standard_H8",
         "allowedValues":[
            "Standard_A4",
            "Standard_A7",
            "Standard_A8",
            "Standard_A9",
            "Standard_A10",
            "Standard_A11",
            "Standard_D4",
            "Standard_D13",
            "Standard_D14",
            "Standard_DS4",
            "Standard_DS13",
            "Standard_DS14",
            "Standard_DS1_v2",
            "Standard_DS2_v2",
            "Standard_DS3_v2",
            "Standard_DS4_v2",
            "Standard_DS5_v2",
            "Standard_DS11_v2",
            "Standard_DS12_v2",
            "Standard_DS13_v2",
            "Standard_DS14_v2",
            "Standard_F4",
            "Standard_F8",
            "Standard_F16",
            "Standard_G3",
            "Standard_G4",
            "Standard_G5",
            "Standard_GS3",
            "Standard_GS4",
            "Standard_GS5",
            "Standard_H8",
            "Standard_H16",
            "Standard_H8m",
            "Standard_H16m",
            "Standard_H16mr",
            "Standard_H16r",
            "Standard_L4",
            "Standard_L8",
            "Standard_L16",
            "Standard_L32"
         ],
         "metadata":{
            "description":"Size of the head node."
         }
      },
      "nodeCount":{
         "type":"int",
         "defaultValue":2,
         "metadata":{
            "description":"The number of nodes in the cluster, including the headnode"
         },
         "minValue":2,
         "maxValue":100
      },
      "dataDiskSize":{
         "type":"int",
         "defaultValue":128,
         "metadata":{
            "description":"The size in GB of each data disk that is attached to the VM.  A RAID-0 volume is created with all data disks that is dataDiskSize * dataDiskCount in size."
         }
      },
      "storageAccountType":{
         "type":"string",
         "defaultValue":"Standard_LRS",
         "allowedValues":[
            "Standard_LRS",
            "Premium_LRS"
         ],
         "metadata":{
            "description":"Type of storage account to create for disks."
         }
      },
      "clusterFilesystemLocation":{
         "type":"string",
         "defaultValue":"/data/beegfs/storage",
         "allowedValues":[
            "/data/beegfs/storage",
            "/mnt/resource/storage"
         ],
         "metadata":{
            "description":"Path to use for BeeGFS storage."
         }
      }
   },
   "variables":{
      "imagePublisher":"OpenLogic",
      "imageOffer":"[parameters('imageOffer')]",
      "imageSku":"7.1",
      "publicIPAddressType":"Dynamic",
      "publicIPAddressName":"publicips",
      "nodePrefix":"node",
      "armApiVersion":"2015-06-15",
      "nicName":"nic",
      "networkSettings":{
         "virtualNetworkName":"virtualnetwork",
         "addressPrefix":"10.0.0.0/16",
         "subnet":{
            "dse":{
               "name":"dse",
               "prefix":"10.0.0.0/24",
               "vnet":"virtualnetwork"
            }
         },
         "statics":{
            "workerRange":{
               "base":"10.0.0.",
               "start":5
            },
            "master":"10.0.0.254"
         }
      },
      "templateBaseUrl":"https://raw.githubusercontent.com/smith1511/hpc/master/slurm-on-centos-managed-disks/",
      "installationCLI":"[concat('bash azuredeploy.sh ', variables('nodePrefix'), ' ', parameters('nodeCount'), ' ', parameters('hpcUserName'), ' ', variables('templateBaseUrl'), ' ', parameters('clusterFilesystemLocation'))]"
   },
   "resources":[
      {
         "type":"Microsoft.Compute/virtualMachineScaleSets",
         "sku":{
            "name":"[parameters('nodeSize')]",
            "tier":"Standard",
            "capacity":"[parameters('nodeCount')]"
         },
         "name":"scaleset",
         "apiVersion":"2016-04-30-preview",
         "location":"[resourceGroup().location]",
         "properties":{
            "singlePlacementGroup":true,
            "upgradePolicy":{
               "mode":"Manual"
            },
            "virtualMachineProfile":{
               "osProfile":{
                  "computerNamePrefix":"[variables('nodePrefix')]",
                  "adminUsername":"[parameters('adminUsername')]",
                  "adminPassword":"[parameters('adminPassword')]",
                  "linuxConfiguration":{
                     "disablePasswordAuthentication":false
                  },
                  "secrets":[

                  ]
               },
               "storageProfile":{
                  "osDisk":{
                     "createOption":"FromImage",
                     "caching":"ReadWrite",
                     "managedDisk":{
                        "storageAccountType":"[parameters('storageAccountType')]"
                     }
                  },
                  "dataDisks":[
                     {
                        "lun":"1",
                        "createOption":"empty",
                        "diskSizeGB":"128"
                     }
                  ],
                  "imageReference":{
                     "publisher":"OpenLogic",
                     "offer":"[parameters('imageOffer')]",
                     "sku":"7.2",
                     "version":"latest"
                  }
               },
               "networkProfile":{
                  "networkInterfaceConfigurations":[
                     {
                        "name":"Nic",
                        "properties":{
                           "primary":true,
                           "ipConfigurations":[
                              {
                                 "name":"IpConfig",
                                 "properties":{
                                    "subnet":{
                                       "id":"[concat(resourceId('Microsoft.Network/virtualNetworks', 'vnet'), '/subnets/default')]"
                                    },
                                    "loadBalancerBackendAddressPools":[
                                       {
                                          "id":"[concat(resourceId('Microsoft.Network/loadBalancers' ,'lb'), '/backendAddressPools/bepool')]"
                                       }
                                    ],
                                    "loadBalancerInboundNatPools":[
                                       {
                                          "id":"[concat(resourceId('Microsoft.Network/loadBalancers', 'lb'), '/inboundNatPools/natpool')]"
                                       }
                                    ]
                                 }
                              }
                           ]
                        }
                     }
                  ]
               },
               "extensionProfile":{
                  "extensions":[
                     {
                        "name":"lapextension",
                        "properties":{
                           "publisher":"Microsoft.Azure.Extensions",
                           "type":"CustomScript",
                           "typeHandlerVersion":"2.0",
                           "autoUpgradeMinorVersion":false,
                           "settings":{
                              "fileUris":[
                                 "[concat(variables('templateBaseUrl'), 'azuredeploy.sh')]"
                              ]
                           },
                           "protectedSettings":{
                              "commandToExecute": "[variables('installationCLI')]"
                           }
                        }
                     }
                  ]
               }
            },
            "overprovision":true
         },
         "dependsOn":[
            "[resourceId('Microsoft.Network/virtualNetworks', 'vnet')]",
            "[resourceId('Microsoft.Network/loadBalancers', 'lb')]"
         ]
      },
      {
         "type":"Microsoft.Network/loadBalancers",
         "name":"lb",
         "apiVersion":"2016-03-30",
         "location":"[resourceGroup().location]",
         "properties":{
            "frontendIPConfigurations":[
               {
                  "name":"LoadBalancerFrontEnd",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "publicIPAddress":{
                        "id":"[resourceId('Microsoft.Network/publicIPAddresses', 'pip')]"
                     }
                  }
               }
            ],
            "backendAddressPools":[
               {
                  "name":"bepool"
               }
            ],
            "loadBalancingRules":[

            ],
            "probes":[

            ],
            "inboundNatRules":[

            ],
            "outboundNatRules":[

            ],
            "inboundNatPools":[
               {
                  "name":"natpool",
                  "properties":{
                     "frontendPortRangeStart":50000,
                     "frontendPortRangeEnd":50100,
                     "backendPort":22,
                     "protocol":"Tcp",
                     "frontendIPConfiguration":{
                        "id":"[concat(resourceId('Microsoft.Network/loadBalancers', 'lb'), '/frontendIPConfigurations/loadBalancerFrontEnd')]"
                     }
                  }
               }
            ]
         },
         "dependsOn":[
            "[resourceId('Microsoft.Network/publicIPAddresses', 'pip')]"
         ]
      },
      {
         "type":"Microsoft.Network/publicIPAddresses",
         "name":"pip",
         "apiVersion":"2016-03-30",
         "location":"[resourceGroup().location]",
         "properties":{
            "publicIPAllocationMethod":"Dynamic",
            "idleTimeoutInMinutes":4
         },
         "dependsOn":[

         ]
      },
      {
         "type":"Microsoft.Network/virtualNetworks",
         "name":"vnet",
         "apiVersion":"2016-03-30",
         "location":"[resourceGroup().location]",
         "properties":{
            "addressSpace":{
               "addressPrefixes":[
                  "10.0.0.0/16"
               ]
            },
            "subnets":[
               {
                  "name":"default",
                  "properties":{
                     "addressPrefix":"10.0.0.0/21"
                  }
               }
            ]
         },
         "dependsOn":[

         ]
      }
   ]
}